// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String      @id @default(uuid())
  email           String      @unique
  password        String      // Hashed with bcrypt
  username        String      // User's handle/identifier
  displayName     String?     // Custom display name (falls back to username)
  bio             String?     // User bio/description
  avatarUrl       String?     // URL to user's avatar image
  likesPrivate    Boolean     @default(false) // Hide from public like lists
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  likedQuotes     QuoteLike[]
  collections     Collection[]
  activities      Activity[]
  
  // Following relationships
  following       Follow[]    @relation("UserFollowing")  // Users this user follows
  followers       Follow[]    @relation("UserFollowers")  // Users following this user

  @@map("users")
}

model Quote {
  id        String      @id @default(uuid())
  text      String
  author    String
  category  String?
  tags      String?     // Stored as comma-separated string
  source    String?
  isPublic  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  likes     QuoteLike[]
  collectionQuotes CollectionQuote[]

  @@map("quotes")
}

model QuoteLike {
  id        String   @id @default(uuid())
  userId    String
  quoteId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, quoteId]) // A user can only like a quote once
  @@map("quote_likes")
}

model Collection {
  id          String            @id @default(uuid())
  name        String
  description String?
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotes      CollectionQuote[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("collections")
}

model CollectionQuote {
  id           String     @id @default(uuid())
  collectionId String
  quoteId      String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  quote        Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  addedAt      DateTime   @default(now())

  @@unique([collectionId, quoteId]) // A quote can only be in a collection once
  @@map("collection_quotes")
}

model Activity {
  id           String   @id @default(uuid())
  userId       String
  activityType String   // 'like', 'collectionCreate', 'collectionUpdate', 'quoteAdd'
  quoteId      String?
  collectionId String?
  metadata     String?  // JSON string for additional data
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("activities")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   // User who is following
  followingId String   // User being followed
  createdAt   DateTime @default(now())
  
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId]) // A user can only follow another user once
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}
